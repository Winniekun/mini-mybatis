# MyBatis核心架构图

## 🏛️ 完整架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         应用层 (Your Code)                       │
│                                                                  │
│    SqlSessionFactory factory = builder.build(config);           │
│    SqlSession session = factory.openSession();                  │
│    UserMapper mapper = session.getMapper(UserMapper.class);     │
│    User user = mapper.selectById(1L);                           │
│                                                                  │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                      接口层 (API Layer)                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  SqlSessionFactoryBuilder                                 │  │
│  │    └─> build(InputStream)                                 │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  SqlSessionFactory                                        │  │
│  │    └─> openSession()                                      │  │
│  └──────────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  SqlSession                                               │  │
│  │    ├─> selectOne(statementId, parameter)                 │  │
│  │    ├─> selectList(statementId, parameter)                │  │
│  │    ├─> insert/update/delete                              │  │
│  │    └─> getMapper(Class<T>)                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                   动态代理层 (Proxy Layer) ⭐核心                 │
│                                                                  │
│  ┌──────────────────┐      ┌──────────────────┐                │
│  │ MapperRegistry   │◄─────┤ Configuration    │                │
│  │  存储所有Mapper   │      │  全局配置中心     │                │
│  └────────┬─────────┘      └──────────────────┘                │
│           │                                                     │
│           │ getMapper(UserMapper.class)                        │
│           ▼                                                     │
│  ┌──────────────────┐                                          │
│  │MapperProxyFactory│                                          │
│  │  创建代理对象     │                                          │
│  └────────┬─────────┘                                          │
│           │ newInstance()                                      │
│           ▼                                                     │
│  ┌──────────────────────────────────┐                          │
│  │      JDK Dynamic Proxy           │                          │
│  │  Proxy.newProxyInstance(...)     │                          │
│  └────────┬─────────────────────────┘                          │
│           │                                                     │
│           ▼                                                     │
│  ┌──────────────────────────────────┐                          │
│  │      MapperProxy                 │                          │
│  │  InvocationHandler               │                          │
│  │    └─> invoke(proxy, method, args)│                         │
│  │         │                         │                          │
│  │         ├─> 构建statementId       │                          │
│  │         ├─> 获取参数              │                          │
│  │         ├─> 判断返回类型          │                          │
│  │         └─> 调用SqlSession        │                          │
│  └──────────────────────────────────┘                          │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                    执行器层 (Executor Layer)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Executor (接口)                                          │  │
│  │    ├─> query(statementId, parameter)                     │  │
│  │    └─> update(statementId, parameter)                    │  │
│  └──────────────────┬───────────────────────────────────────┘  │
│                     │                                           │
│         ┌───────────┼───────────┐                              │
│         ▼           ▼           ▼                              │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐                       │
│  │ Simple   │ │  Reuse   │ │  Batch   │                       │
│  │ Executor │ │ Executor │ │ Executor │                       │
│  └──────────┘ └──────────┘ └──────────┘                       │
│       │                                                         │
│       │ 1. 获取MappedStatement                                 │
│       │ 2. 创建StatementHandler                                │
│       ▼                                                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  StatementHandler                                         │  │
│  │    ├─> prepare(connection, sql)    // 创建Statement       │  │
│  │    ├─> parameterize(stmt, param)   // 设置参数           │  │
│  │    └─> query(stmt, resultType)     // 执行+结果映射       │  │
│  └──────────────────┬───────────────────────────────────────┘  │
└─────────────────────┼──────────────────────────────────────────┘
                      │
┌─────────────────────▼──────────────────────────────────────────┐
│                    JDBC层 (JDBC Layer)                          │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Connection                                               │  │
│  │    └─> prepareStatement(sql)                             │  │
│  └──────────────────┬───────────────────────────────────────┘  │
│                     ▼                                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  PreparedStatement                                        │  │
│  │    ├─> setObject(index, value)    // 设置参数            │  │
│  │    └─> executeQuery()              // 执行SQL            │  │
│  └──────────────────┬───────────────────────────────────────┘  │
│                     ▼                                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ResultSet                                                │  │
│  │    ├─> next()                                             │  │
│  │    ├─> getLong("id")                                      │  │
│  │    ├─> getString("username")                              │  │
│  │    └─> ...                                                │  │
│  └──────────────────┬───────────────────────────────────────┘  │
└─────────────────────┼──────────────────────────────────────────┘
                      │
┌─────────────────────▼──────────────────────────────────────────┐
│                  结果映射层 (Mapping Layer)                      │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  ResultSetHandler                                         │  │
│  │    └─> handleResultSet(resultSet, resultType)            │  │
│  │         │                                                 │  │
│  │         ├─> 1. while(rs.next())                           │  │
│  │         ├─> 2. 创建对象: new User()                        │  │
│  │         ├─> 3. 映射字段:                                   │  │
│  │         │     user.setId(rs.getLong("id"))               │  │
│  │         │     user.setUsername(rs.getString("username"))  │  │
│  │         │     ...                                         │  │
│  │         └─> 4. 返回对象列表                               │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                   配置解析层 (Builder Layer)                     │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  XMLConfigBuilder                                         │  │
│  │    └─> parse(mybatis-config.xml)                         │  │
│  │         ├─> 解析<environments>                            │  │
│  │         └─> 解析<mappers>                                 │  │
│  └──────────────────┬───────────────────────────────────────┘  │
│                     ▼                                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  XMLMapperBuilder                                         │  │
│  │    └─> parse(UserMapper.xml)                             │  │
│  │         ├─> 解析namespace                                 │  │
│  │         ├─> 解析<select>/<insert>/<update>/<delete>      │  │
│  │         └─> 创建MappedStatement                           │  │
│  └──────────────────┬───────────────────────────────────────┘  │
│                     ▼                                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  Configuration                                            │  │
│  │    ├─> mappedStatements: Map<String, MappedStatement>    │  │
│  │    ├─> mapperRegistry: MapperRegistry                    │  │
│  │    ├─> interceptorChain: InterceptorChain                │  │
│  │    └─> 数据源配置                                          │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    数据模型 (Data Model)                         │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  MappedStatement                                          │  │
│  │    ├─> id: "UserMapper.selectById"                       │  │
│  │    ├─> sqlCommandType: SELECT                            │  │
│  │    ├─> sql: "SELECT * FROM user WHERE id = #{id}"        │  │
│  │    ├─> parameterType: Long.class                         │  │
│  │    └─> resultType: User.class                            │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 🔄 完整执行流程（时序图）

```
用户代码          SqlSession      MapperProxy      Executor      StatementHandler   JDBC
   │                  │               │               │                │             │
   │ getMapper()      │               │               │                │             │
   ├─────────────────>│               │               │                │             │
   │                  │ 创建代理       │               │                │             │
   │                  ├──────────────>│               │                │             │
   │<─────────────────┴───────────────┤               │                │             │
   │  返回$Proxy对象   │               │               │                │             │
   │                  │               │               │                │             │
   │ selectById(1L)   │               │               │                │             │
   ├──────────────────────────────────>│               │                │             │
   │                  │               │ invoke()      │                │             │
   │                  │               │ 拦截方法调用   │                │             │
   │                  │               │               │                │             │
   │                  │               │ selectOne()   │                │             │
   │                  │<──────────────┤               │                │             │
   │                  │               │               │                │             │
   │                  │ query()       │               │                │             │
   │                  ├───────────────────────────────>│                │             │
   │                  │               │               │ prepare()      │             │
   │                  │               │               ├───────────────>│             │
   │                  │               │               │                │ prepareStmt │
   │                  │               │               │                ├────────────>│
   │                  │               │               │                │<────────────┤
   │                  │               │               │<───────────────┤             │
   │                  │               │               │                │             │
   │                  │               │               │ parameterize() │             │
   │                  │               │               ├───────────────>│             │
   │                  │               │               │                │ setObject() │
   │                  │               │               │                ├────────────>│
   │                  │               │               │<───────────────┤             │
   │                  │               │               │                │             │
   │                  │               │               │ query()        │             │
   │                  │               │               ├───────────────>│             │
   │                  │               │               │                │executeQuery │
   │                  │               │               │                ├────────────>│
   │                  │               │               │                │ ResultSet   │
   │                  │               │               │                │<────────────┤
   │                  │               │               │                │             │
   │                  │               │               │                │ 映射结果     │
   │                  │               │               │<───────────────┤             │
   │                  │               │               │ List<User>     │             │
   │                  │<──────────────────────────────┤                │             │
   │                  │ User对象      │               │                │             │
   │                  ├──────────────>│               │                │             │
   │<─────────────────────────────────┤               │                │             │
   │  返回User         │               │               │                │             │
```

---

## 🎯 核心组件关系

```
                    ┌───────────────┐
                    │Configuration  │ 全局配置中心
                    │  (单例)       │
                    └───────┬───────┘
                            │拥有
                    ┌───────▼────────┐
          ┌─────────┤ MapperRegistry │
          │         │  Mapper注册表  │
          │         └────────────────┘
          │
          │         ┌─────────────────────┐
          │         │ MappedStatements    │
          │         │ Map<String, MS>     │
          │         │  SQL语句存储        │
          │         └─────────────────────┘
          │
          │注册     ┌──────────────────┐
          └────────>│ MapperProxy      │
                    │   Factory        │
                    └────────┬─────────┘
                             │创建
                    ┌────────▼─────────┐
                    │  $Proxy对象      │
                    │  (实现Mapper接口) │
                    └──────────────────┘
```

---

## 💡 关键设计点

### 1. 为什么用动态代理？
```
优点：
✅ 不需要写Mapper实现类
✅ 接口和SQL解耦
✅ 统一的方法拦截和处理

如果不用代理：
❌ 需要为每个Mapper写实现类
❌ 代码重复（每个方法都是：获取SQL→执行→映射结果）
❌ 维护成本高
```

### 2. 为什么用statementId？
```
问题：如何关联接口方法和XML中的SQL？

解决方案：
接口方法: UserMapper.selectById()
     ↓ 生成statementId
   "com.mybatis.test.mapper.UserMapper.selectById"
     ↓ 查找
MappedStatement: 包含SQL和所有配置
     ↓
执行SQL
```

### 3. Configuration的作用
```
Configuration就像一个大仓库：
┌────────────────────────────┐
│ Configuration              │
├────────────────────────────┤
│ • 数据源信息               │
│ • 所有MappedStatement      │
│ • Mapper注册表             │
│ • 插件链                   │
│ • 类型处理器               │
│ • ...                      │
└────────────────────────────┘

所有组件都可以访问Configuration获取信息
```

---

## 📊 对象生命周期

```
对象                  生命周期              作用域         线程安全
────────────────────────────────────────────────────────────
Configuration       应用启动→关闭         应用级别        ✅是
SqlSessionFactory   应用启动→关闭         应用级别        ✅是
SqlSession          请求开始→结束         请求级别        ❌否
MapperProxy         每次getMapper创建     方法级别        ❌否
Executor            跟随SqlSession        请求级别        ❌否
StatementHandler    每次SQL执行创建       方法级别        ❌否
```

---

**现在你对MyBatis的架构有了全面的理解！** 🎓

