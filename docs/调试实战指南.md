# ğŸ”¬ è°ƒè¯•å®æˆ˜æŒ‡å—

## è°ƒè¯•ç›®æ ‡
é€šè¿‡æ–­ç‚¹è·Ÿè¸ªï¼Œç†è§£ `mapper.selectById(1L)` çš„å®Œæ•´æ‰§è¡Œè¿‡ç¨‹

---

## ğŸ“ æ–­ç‚¹è®¾ç½®

### æ–­ç‚¹1ï¼šMapperProxy.invoke() - ç¬¬80è¡Œ
**ä½ç½®**ï¼š`src/main/java/com/mybatis/binding/MapperProxy.java:80`

**è§‚å¯Ÿå†…å®¹**ï¼š
```java
// å½“ç¨‹åºåœåœ¨è¿™é‡Œæ—¶ï¼Œè§‚å¯Ÿå˜é‡ï¼š
proxy   = $Proxy5@1234           // ä»£ç†å¯¹è±¡
method  = selectById(Long)       // è¢«è°ƒç”¨çš„æ–¹æ³•
args    = [1L]                   // æ–¹æ³•å‚æ•°
```

**æ­¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
```
ç”¨æˆ·ä»£ç : mapper.selectById(1L)
          â†“
JDKåŠ¨æ€ä»£ç†æ‹¦æˆª
          â†“
è§¦å‘ MapperProxy.invoke()  â† ä½ åœ¨è¿™é‡Œï¼
```

---

### æ–­ç‚¹2ï¼šMapperProxy.invoke() - ç¬¬87è¡Œ
**ä½ç½®**ï¼šæ„å»ºstatementIdé‚£ä¸€è¡Œ

**è§‚å¯Ÿå†…å®¹**ï¼š
```java
statementId = "com.mybatis.test.mapper.UserMapper.selectById"
//            â†‘                                    â†‘
//         namespace                           methodName
```

**ç†è§£**ï¼š
- è¿™ä¸ªIDæ˜¯è¿æ¥æ¥å£æ–¹æ³•å’ŒXMLä¸­SQLçš„æ¡¥æ¢
- Configurationé€šè¿‡è¿™ä¸ªIDæ‰¾åˆ°å¯¹åº”çš„MappedStatement
- MappedStatementåŒ…å«äº†SQLè¯­å¥å’Œæ‰€æœ‰é…ç½®

---

### æ–­ç‚¹3ï¼šMapperProxy.executeMethod() - ç¬¬116è¡Œ
**ä½ç½®**ï¼šåˆ¤æ–­è¿”å›ç±»å‹çš„ifè¯­å¥

**è§‚å¯Ÿå†…å®¹**ï¼š
```java
returnType = class com.mybatis.test.entity.User  // Userç±»å‹
Collection.class.isAssignableFrom(returnType)   // false
```

**æ­¤æ—¶å†³ç­–**ï¼š
- ä¸æ˜¯Collection â†’ ä¸è°ƒç”¨selectList
- ä¸æ˜¯void/int â†’ ä¸è°ƒç”¨update
- æ‰€ä»¥ä¼šè°ƒç”¨selectOne â†’ è·³åˆ°ç¬¬128è¡Œ

---

### æ–­ç‚¹4ï¼šDefaultSqlSession.selectOne() - ç¬¬86è¡Œ
**ä½ç½®**ï¼š`src/main/java/com/mybatis/session/DefaultSqlSession.java:86`

**è§‚å¯Ÿå†…å®¹**ï¼š
```java
statementId = "com.mybatis.test.mapper.UserMapper.selectById"
parameter   = 1L
```

**æ­¤æ—¶å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ**
```java
public <T> T selectOne(String statementId, Object parameter) {
    logger.debug("æ‰§è¡ŒselectOne: {}", statementId);
    List<T> list = selectList(statementId, parameter);  // è°ƒç”¨selectList
    // ... æ£€æŸ¥ç»“æœæ•°é‡
}
```

---

### æ–­ç‚¹5ï¼šSimpleExecutor.query() - ç¬¬48è¡Œ
**ä½ç½®**ï¼š`src/main/java/com/mybatis/executor/SimpleExecutor.java:48`

**è§‚å¯Ÿå†…å®¹**ï¼š
```java
// 1. è·å–MappedStatement
MappedStatement ms = configuration.getMappedStatement(statementId);

// è§‚å¯Ÿmså¯¹è±¡ï¼š
ms.getId()          = "com.mybatis.test.mapper.UserMapper.selectById"
ms.getSql()         = "SELECT id, username, password, email, create_time FROM user WHERE id = #{id}"
ms.getResultType()  = class com.mybatis.test.entity.User
```

**å…³é”®ç†è§£**ï¼š
- Configurationå°±åƒä¸€ä¸ªå¤§ä»“åº“
- é€šè¿‡statementIdæ‰¾åˆ°å¯¹åº”çš„"è´§ç‰©"ï¼ˆMappedStatementï¼‰
- MappedStatementåŒ…å«äº†æ‰§è¡ŒSQLéœ€è¦çš„æ‰€æœ‰ä¿¡æ¯

---

### æ–­ç‚¹6ï¼šStatementHandler.prepare() - ç¬¬57è¡Œ
**ä½ç½®**ï¼š`src/main/java/com/mybatis/executor/statement/StatementHandler.java:57`

**è§‚å¯ŸSQLè½¬æ¢**ï¼š
```java
// åŸå§‹SQLï¼ˆæ¥è‡ªXMLï¼‰
sql = "SELECT * FROM user WHERE id = #{id}"

// é¢„ç¼–è¯‘SQLï¼ˆå‘é€ç»™æ•°æ®åº“ï¼‰
preparedSql = "SELECT * FROM user WHERE id = ?"
//                                          â†‘
//                                      å˜æˆäº†é—®å·
```

**æ­¤æ—¶åˆ›å»ºPreparedStatement**ï¼š
```java
PreparedStatement ps = connection.prepareStatement(preparedSql);
```

---

### æ–­ç‚¹7ï¼šStatementHandler.parameterize() - ç¬¬73è¡Œ
**ä½ç½®**ï¼šè®¾ç½®å‚æ•°çš„åœ°æ–¹

**è§‚å¯Ÿå‚æ•°è®¾ç½®**ï¼š
```java
parameter = 1L
ps.setObject(1, parameter);  // æŠŠ1Lè®¾ç½®åˆ°ç¬¬ä¸€ä¸ª?çš„ä½ç½®
```

**æ­¤æ—¶SQLå˜æˆ**ï¼š
```sql
-- é€»è¾‘ä¸Šç­‰ä»·äºï¼š
SELECT * FROM user WHERE id = 1
```

---

### æ–­ç‚¹8ï¼šStatementHandler.query() - ç¬¬91è¡Œ
**ä½ç½®**ï¼šæ‰§è¡ŒæŸ¥è¯¢çš„åœ°æ–¹

**æ‰§è¡ŒSQL**ï¼š
```java
ResultSet resultSet = ps.executeQuery();  // å‘é€SQLåˆ°æ•°æ®åº“
```

**æ­¤æ—¶æ•°æ®åº“è¿”å›**ï¼š
```
ResultSetåŒ…å«ï¼š
+----+----------+----------+---------------------+---------------------+
| id | username | password | email               | create_time         |
+----+----------+----------+---------------------+---------------------+
|  1 | zhangsan | 123456   | zhangsan@example.com| 2026-01-10 22:56:09|
+----+----------+----------+---------------------+---------------------+
```

---

### æ–­ç‚¹9ï¼šResultSetHandler.handleResultSet() - ç¬¬45è¡Œ
**ä½ç½®**ï¼š`src/main/java/com/mybatis/executor/resultset/ResultSetHandler.java:45`

**è§‚å¯Ÿç»“æœæ˜ å°„**ï¼š
```java
resultType = class com.mybatis.test.entity.User

// éå†ResultSet
while (resultSet.next()) {
    // åˆ›å»ºUserå¯¹è±¡
    User user = new User();
    
    // æ˜ å°„æ¯ä¸ªå­—æ®µ
    user.setId(resultSet.getLong("id"));              // 1L
    user.setUsername(resultSet.getString("username")); // "zhangsan"
    user.setPassword(resultSet.getString("password")); // "123456"
    user.setEmail(resultSet.getString("email"));       // "zhangsan@example.com"
    user.setCreateTime(resultSet.getObject("create_time", LocalDateTime.class));
    
    resultList.add(user);
}
```

---

### æ–­ç‚¹10ï¼šè¿”å›æµ‹è¯•æ–¹æ³•
**ä½ç½®**ï¼š`MybatisTest.java` çš„ `User user = mapper.selectById(1L);` è¿™ä¸€è¡Œåé¢

**æœ€ç»ˆç»“æœ**ï¼š
```java
user = User{
    id=1, 
    username='zhangsan', 
    password='123456', 
    email='zhangsan@example.com', 
    createTime=2026-01-10T22:56:09
}
```

---

## ğŸ¯ å®Œæ•´è°ƒç”¨é“¾

```
ç”¨æˆ·ä»£ç 
  mapper.selectById(1L)
     â†“
JDKåŠ¨æ€ä»£ç†
  $Proxy5.selectById(1L)
     â†“
MapperProxy.invoke()
  - æ„å»ºstatementId
  - åˆ¤æ–­æ–¹æ³•ç±»å‹
     â†“
DefaultSqlSession.selectOne()
  - è°ƒç”¨selectList()
  - æ£€æŸ¥ç»“æœæ•°é‡
     â†“
SimpleExecutor.query()
  - è·å–MappedStatement
  - åˆ›å»ºStatementHandler
     â†“
StatementHandler.prepare()
  - SQLè½¬æ¢: #{} â†’ ?
  - åˆ›å»ºPreparedStatement
     â†“
StatementHandler.parameterize()
  - è®¾ç½®å‚æ•°: setObject(1, 1L)
     â†“
StatementHandler.query()
  - æ‰§è¡ŒSQL: executeQuery()
  - è·å–ResultSet
     â†“
ResultSetHandler.handleResultSet()
  - éå†ResultSet
  - åˆ›å»ºå¯¹è±¡
  - æ˜ å°„å­—æ®µ
     â†“
è¿”å›ç»“æœ
  Userå¯¹è±¡
```

---

## ğŸ’¡ è°ƒè¯•æŠ€å·§

### 1. è§‚å¯Ÿå˜é‡çš„ç±»å‹
```java
// çœ‹åˆ°$Proxyå¼€å¤´çš„ç±»åï¼Œè¯´æ˜æ˜¯åŠ¨æ€ä»£ç†å¯¹è±¡
mapper = $Proxy5@1234
```

### 2. ç†è§£æ–¹æ³•è°ƒç”¨æ ˆ
```
åœ¨IDEçš„Debugé¢æ¿å¯ä»¥çœ‹åˆ°å®Œæ•´çš„è°ƒç”¨æ ˆï¼š
- MybatisTest.testMapperProxy() [ä½ çš„æµ‹è¯•]
- $Proxy5.selectById()           [JDKä»£ç†]
- MapperProxy.invoke()           [æ‹¦æˆªå™¨]
- MapperProxy.executeMethod()    [åˆ¤æ–­ç±»å‹]
- DefaultSqlSession.selectOne()  [ä¼šè¯]
- SimpleExecutor.query()         [æ‰§è¡Œå™¨]
- ...
```

### 3. å…³é”®å¯¹è±¡
```java
// Configuration - å…¨å±€é…ç½®ä¸­å¿ƒ
configuration.getMappedStatement("UserMapper.selectById")

// MappedStatement - SQLé…ç½®
ms.getSql()        // SQLè¯­å¥
ms.getResultType() // è¿”å›ç±»å‹

// Connection - æ•°æ®åº“è¿æ¥
connection.prepareStatement(sql)
```

---

## ğŸ“ å…³é”®å‘ç°

### 1. statementIdçš„é‡è¦æ€§
```
æ¥å£æ–¹æ³• â†â†’ statementId â†â†’ MappedStatement â†â†’ SQL

è¿™æ˜¯æ•´ä¸ªæ˜ å°„å…³ç³»çš„æ ¸å¿ƒï¼
```

### 2. åŠ¨æ€ä»£ç†çš„é­”æ³•
```java
// çœ‹èµ·æ¥æ˜¯è°ƒç”¨æ¥å£æ–¹æ³•
mapper.selectById(1L)

// å®é™…ä¸Šæ˜¯è°ƒç”¨ä»£ç†çš„invokeæ–¹æ³•
MapperProxy.invoke(proxy, selectByIdMethod, [1L])
```

### 3. é…ç½®çš„é›†ä¸­ç®¡ç†
```
æ‰€æœ‰ä¿¡æ¯éƒ½åœ¨Configurationä¸­ï¼š
- æ•°æ®æºä¿¡æ¯
- æ‰€æœ‰çš„MappedStatement
- Mapperæ³¨å†Œè¡¨
- ç±»å‹å¤„ç†å™¨
- ...
```

---

## ğŸ“ è°ƒè¯•ç»ƒä¹ 

### ç»ƒä¹ 1ï¼šä¿®æ”¹SQLï¼Œè§‚å¯Ÿå˜åŒ–
ä¿®æ”¹ `UserMapper.xml`ï¼š
```xml
<select id="selectById" parameterType="java.lang.Long" resultType="com.mybatis.test.entity.User">
    SELECT id, username, email FROM user WHERE id = #{id}
    <!-- æ³¨æ„ï¼šåªæŸ¥3ä¸ªå­—æ®µ -->
</select>
```

**é—®é¢˜**ï¼špasswordå­—æ®µä¼šæ˜¯ä»€ä¹ˆå€¼ï¼Ÿ

### ç»ƒä¹ 2ï¼šè°ƒç”¨selectAllæ–¹æ³•
```java
List<User> users = mapper.selectAll();
```

**è§‚å¯Ÿ**ï¼š
- executeMethod()ä¼šèµ°å“ªä¸ªåˆ†æ”¯ï¼Ÿ
- ResultSetHandlerå¦‚ä½•å¤„ç†å¤šæ¡è®°å½•ï¼Ÿ

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨ä½ å·²ç»å®Œå…¨ç†è§£äº†MyBatisçš„æ‰§è¡Œæµç¨‹ï¼

æ˜å¤©æˆ‘ä»¬ä¼šå­¦ä¹ ï¼š
1. **Configurationçš„å†…éƒ¨ç»“æ„**
2. **XMLè§£æçš„è¯¦ç»†è¿‡ç¨‹**
3. **å¦‚ä½•è‡ªå·±å†™ä¸€ä¸ªMapper**

**ä»Šå¤©çš„ä½œä¸š**ï¼š
1. å®Œæ•´è°ƒè¯•ä¸€éä»£ç 
2. ç”»å‡ºè‡ªå·±ç†è§£çš„æµç¨‹å›¾
3. æ€è€ƒï¼šå¦‚æœè®©ä½ è®¾è®¡ï¼Œä½ ä¼šæ€ä¹ˆåšï¼Ÿ

---

**è°ƒè¯•æ„‰å¿«ï¼è¿™æ˜¯ç†è§£æ¡†æ¶æœ€å¥½çš„æ–¹å¼ï¼** ğŸ”

